# Memory 객체 구현하기

## 목표

프로세스 메모리 모델을 학습한 것을 바탕으로 메모리 시뮬레이션을 구현해본다.
모든 것을 전부 똑같이 구현하려고 하지말고, 내가 이해한 것을 바탕으로 구현을 한다.
기본적으로 메모리 모델에는 힙,스텍 외에 데이터 영역과 GVAR 영역이 존재하지만 이번에는 그 부분은 구현하지 않는다.

## 명세

### 1. Memory 클래스 ￼

• 전체 메모리 관리(스택, 힙, 타입 정보 등)를 담당

### 2. 스택 (Stack) ￼

this.stack 배열에는 다양한 종류의 스택 항목(Stack Entry) 객체가 저장됩니다. 각 객체는 스택의 논리적인 한 단위를 나타내며,

모두 stackAddr (number) 속성을 공통으로 가집니다. stackAddr는 해당 항목이 스택 내에서 차지하는 논리적인 메모리 주소 (baseAddress + offset)입니다.

#### 스텍에 들어갈 수 있는 주요 형태

- 1. 힙 포인터 (type : "pointer")
     malloc() 호출을 통해 힙에 할당된 메모리 블럭을 가리키는 포인터입니다.
     함수 내 지역 변수가 동적으로 할당된 메모리를 참조할 때 이 형태로 스텍에 push 됩니다.

- 2. 함수 매개변수(type: "params")
     call() 호출 시 함수에 전달되는 매개변수를 나태는 항목입니다.
     실제값 대신 매개변수 공간의 논리적 위치를 나타냅니다.

### 3. 힙 (Heap) ￼

- 객체(Map) 사용
- key : 힙 메모리 블록의 시작 주소(baseAddress + offset)
- value : 다음과 같은 속성을 가진 객체

```js
interface HeapEntry {
  size: number; // 할당된 힙 메모리 블록의 총 크기 (바이트)
  dataType: string; // 이 힙 메모리 블록이 저장하도록 의도된 논리적인 데이터 타입
  count: number; // 할당된 dataType 항목의 개수 (예: int 4개)
  refCount: number; // 현재 이 힙 메모리 블록을 참조하는 유효한 스택 포인터의 개수. 이 값이 0이 되면 garbageCollect()의 대상이 됨.
}
```

---

### `init(stackSize, heapSize)`

- **설명**: 메모리 시뮬레이터의 스택과 힙 영역의 크기를 설정하고, 모든 내부 상태를 초기화합니다. 이 메서드는 시뮬레이션 시작 전에 반드시 호출되어야 합니다.
- **Input**:
  - `stackSize` (number): 스택 영역의 **총 바이트 크기** (양수여야 함).
  - `heapSize` (number): 힙 영역의 **총 바이트 크기** (양수여야 함).
- **Output**:
  - `number`: 설정된 **기본 메모리 시작 주소** (`baseAddress`).
- **오류**: `stackSize` 또는 `heapSize`가 0 이하일 경우 `Error`를 발생시킵니다.

---

### `setSize(type, length)`

- **설명**: 새로운 사용자 정의 데이터 타입을 등록하고 해당 타입의 논리적인 바이트 크기를 지정합니다. 한 번 등록된 타입은 중복하여 등록할 수 없습니다.
- **Input**:
  - `type` (string): 등록할 데이터 타입의 **이름** (예: "int", "string", "MyStruct").
  - `length` (number): 해당 타입이 차지하는 **바이트 크기**. 허용되는 값은 `1, 2, 4, 8, 16, 32` 중 하나입니다. (참고: 실제 `malloc` 시 8바이트 미만은 8바이트로 패딩됩니다.)
- **Output**: 없음
- **오류**:
  - `length`가 허용되지 않는 값일 경우 `Error`를 발생시킵니다.
  - `type`이 이미 등록되어 있을 경우 `Error`를 발생시킵니다.

---

### `malloc(type, count = 1)`

- **설명**: 지정된 `type`의 메모리를 `count`만큼 힙 영역에 할당하고, 할당된 힙 메모리의 주소를 가리키는 포인터를 스택에 저장합니다. 힙 메모리는 실제 데이터가 아닌 메타데이터(타입, 크기, 참조 카운트 등)로 관리됩니다.
- **Input**:
  - `type` (string): 할당할 메모리의 **데이터 타입 이름** (미리 `setSize`로 등록되어 있어야 함).
  - `count` (number, 기본값 `1`): 할당할 `type`의 **개수** (1 이상이어야 함).
- **Output**:
  - `number`: 스택에 저장된 **힙 포인터의 주소** (`baseAddress + offset`).
- **오류**:
  - `type`이 `setSize`로 등록되지 않았을 경우 `Error`를 발생시킵니다.
  - `count`가 0 이하일 경우 `Error`를 발생시킵니다.
  - 힙 또는 스택 메모리가 부족할 경우 `Error`를 발생시킵니다.

---

### `free(pointer)`

- **설명**: 스택에 존재하는 특정 포인터를 제거하여, 해당 포인터가 가리키던 힙 메모리에 대한 참조를 끊습니다. **힙 메모리 자체는 즉시 해제되지 않고**, 참조 카운트(`refCount`)만 감소합니다. 실제 힙 메모리 해제는 `garbageCollect()` 메서드에 의해 수행됩니다.
- **Input**:
  - `pointer` (number): 스택에 저장된 **힙 포인터의 주소** (`baseAddress + offset` 형태).
- **Output**: 없음
- **오류**: 해당 `pointer`가 스택에서 유효한 힙 포인터로 발견되지 않을 경우 `Error`를 발생시킵니다.

---

### `call(name, paramCount)`

- **설명**: 함수 호출을 시뮬레이션하여 함수 프레임을 호출 스택에 추가하고, 해당 함수에 필요한 매개변수 공간을 스택에 할당합니다.
- **Input**:
  - `name` (string): 호출할 **함수의 이름** (최대 8자, 비어있지 않아야 함).
  - `paramCount` (number): 함수의 **매개변수 개수** (0 이상 10 이하).
- **Output**: 없음
- **오류**:
  - `name`이 유효하지 않거나 길이 제한을 초과할 경우 `Error`를 발생시킵니다.
  - `paramCount`가 허용 범위를 벗어날 경우 `Error`를 발생시킵니다.
  - 스택 메모리가 부족하여 매개변수 공간을 할당할 수 없을 경우 `Error`를 발생시킵니다.

---

### `returnFrom(name)`

- **설명**: 함수 호출 스택에서 가장 최근에 호출된 함수 프레임을 제거합니다. 해당 함수 호출 이후 스택에 할당되었던 모든 항목(매개변수, `malloc`으로 생성된 로컬 포인터 등)도 스택에서 제거됩니다. 제거되는 힙 포인터가 참조하던 힙 메모리의 참조 카운트가 감소합니다. 힙 메모리 자체는 해제되지 않고 가비지로 남습니다.
- **Input**:
  - `name` (string): 반환하려는 **함수의 이름**. 이 이름은 가장 최근에 호출된 함수의 이름과 일치해야 합니다.
- **Output**: 없음
- **오류**: `name`이 가장 최근에 호출된 함수의 이름과 다를 경우 `Error`를 발생시킵니다. (호출 스택이 비어있으면 아무런 동작도 하지 않습니다.)

---

### `usage()`

- **설명**: 현재 스택 및 힙 메모리의 사용 현황을 반환합니다. 힙 사용량은 현재 유효하게 참조되고 있는 메모리의 총량을 나타냅니다.
- **Input**: 없음
- **Output**:
  - `[number, number, number, number, number, number]` 형태의 배열:
    1.  **스택 전체 크기** (바이트)
    2.  **스택 사용 중인 용량** (바이트)
    3.  **스택 남은 용량** (바이트)
    4.  **힙 전체 크기** (바이트)
    5.  **힙 사용 중인 용량** (바이트, `refCount` > 0인 메모리 합계)
    6.  **힙 남은 용량** (바이트, `힙 전체 크기 - 실제 힙 사용 중인 용량`)

---

### `callstack()`

- **설명**: 현재 메모리 시뮬레이터에 쌓여있는 함수 호출 스택의 상태를 문자열로 표현하여 반환합니다. 각 함수 프레임은 함수 이름과 해당 스택 주소를 포함합니다.
- **Input**: 없음
- **Output**:
  - `string`: "함수이름() 스택의 주소 -> 함수이름() 스택의 주소"와 같은 형식의 문자열. 호출 스택이 비어있으면 "호출 스택이 비어있습니다."를 반환합니다.

---

### `heapdump()`

- **설명**: 힙 영역에 할당된 모든 메모리 블록의 상세 정보를 문자열 배열 형태로 반환합니다. 각 항목은 할당된 주소, 데이터 타입, 할당 크기, 할당 개수, 현재 참조 카운트, 그리고 해당 힙을 참조하는 스택 포인터들의 주소 정보를 포함합니다.
- **Input**: 없음
- **Output**:
  - `string[]`: 힙 메모리 블록별 정보를 담은 문자열 배열. 힙이 비어있으면 "힙 영역이 비어있습니다."가 담긴 배열을 반환합니다.

---

### `garbageCollect()`

- **설명**: 힙 영역에 할당된 메모리 블록들 중, 더 이상 스택 등에서 참조되지 않는 (즉, 참조 카운트가 0인) "가비지" 메모리를 찾아 실제로 힙에서 해제합니다. 이 과정에서 힙의 총 사용량(`heapPointer`)도 줄어듭니다.
- **Input**: 없음
- **Output**: 없음 (내부 상태 변경)

---

### `reset()`

- **설명**: 메모리 시뮬레이터의 모든 상태(스택, 힙, 타입 정의, 호출 스택, 포인터)를 초기 `constructor` 상태로 되돌립니다. `init()` 메서드를 다시 호출하기 전에 현재 상태를 깨끗하게 정리하는 데 사용됩니다.
- **Input**: 없음
- **Output**: 없음 (내부 상태 초기화)
